<x-app-layout>
    <x-slot name="header">
        <h2 class="font-semibold text-lg lg:text-xl text-gray-800 leading-tight">
            {{ __('Interactive Crop Production Map') }}
        </h2>
    </x-slot>

    <div class="py-4 lg:py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Personalized Welcome Banner (if user has preferences) -->
            @if(isset($preferredMunicipality) && $preferredMunicipality)
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-4 lg:mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-100 p-2 rounded-full">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-green-800">Your Farm Location: <span class="font-bold">{{ ucwords(strtolower($preferredMunicipality)) }}</span></p>
                            <p class="text-xs text-green-600">Map is focused on your municipality</p>
                        </div>
                    </div>
                    <button onclick="focusOnMyMunicipality()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Focus on My Location
                    </button>
                </div>
            </div>
            @endif

            <!-- Control Panel -->
            <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg mb-4 lg:mb-6">
                <div class="p-4 lg:p-6">
                    <h3 class="text-base lg:text-lg font-semibold text-gray-800 mb-3 lg:mb-4">Map Controls</h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                        <!-- Crop Filter -->
                        <div>
                            <label for="crop-filter" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">
                                Crop Type
                            </label>
                            <select id="crop-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm lg:text-base">
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <!-- Year Filter -->
                        <div>
                            <label for="year-filter" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">
                                Year
                            </label>
                            <select id="year-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm lg:text-base">
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <!-- View Type Filter -->
                        <div>
                            <label for="view-filter" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">
                                View Type
                            </label>
                            <select id="view-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm lg:text-base">
                                <option value="production">Total Production (kg)</option>
                                <option value="area_harvested">Area Harvested (ha)</option>
                                <option value="productivity">Productivity (kg/ha)</option>
                            </select>
                        </div>

                        <!-- Farm Type Filter -->
                        <div>
                            <label for="farm-type-filter" class="block text-xs lg:text-sm font-medium text-gray-700 mb-1 lg:mb-2">
                                Farm Type
                            </label>
                            <select id="farm-type-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm lg:text-base">
                                <option value="">All Farm Types</option>
                                <option value="Irrigated">Irrigated</option>
                                <option value="Rainfed">Rainfed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Toggle Options -->
                    <div class="flex items-center gap-4 mt-4 pt-4 border-t border-gray-100">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-boundaries" checked class="sr-only peer">
                            <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ms-2 text-sm text-gray-600">Show Boundaries</span>
                        </label>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="hidden mt-4">
                        <div class="flex items-center text-green-600">
                            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Loading map data...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                <div class="p-3 lg:p-6 relative">
                    <div id="map" style="height: 400px; width: 100%;" class="rounded-lg shadow-inner sm:h-[500px] lg:h-[600px]"></div>
                    
                    <!-- Legend - Collapsible on mobile -->
                    <div id="legend" class="absolute bottom-4 left-4 lg:bottom-8 lg:left-8 bg-white rounded-lg shadow-lg border-2 border-gray-200 z-[1000] max-w-[200px] sm:max-w-[240px] lg:max-w-[280px]">
                        <!-- Toggle Button (Mobile Only) -->
                        <button id="legend-toggle" onclick="toggleLegend()" class="lg:hidden w-full flex items-center justify-between p-3 font-bold text-gray-800 text-xs uppercase tracking-wide">
                            <span>Legend</span>
                            <svg id="legend-icon" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Legend Content -->
                        <div id="legend-wrapper" class="hidden lg:block p-3 lg:p-4">
                            <h4 class="hidden lg:block font-bold text-gray-800 mb-2 lg:mb-3 text-xs lg:text-sm uppercase tracking-wide">Production Legend</h4>
                            <div id="legend-content">
                                <span class="text-xs text-gray-600">Select filters to view data</span>
                            </div>
                        </div>
                    </div>

                    <!-- Municipality Details Panel - Slides from right -->
                    <div id="details-panel" class="fixed top-0 right-0 h-full bg-white shadow-2xl z-[2000] transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto w-full sm:w-[400px] lg:w-[450px]">
                        <div class="p-4 lg:p-6">
                            <!-- Close Button -->
                            <button onclick="closeDetailsPanel()" class="absolute top-3 right-3 lg:top-4 lg:right-4 text-gray-500 hover:text-gray-700">
                                <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>

                            <!-- Panel Header -->
                            <div class="mb-4 lg:mb-6 pr-8">
                                <h2 id="panel-municipality-name" class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Municipality Name</h2>
                                <p class="text-xs lg:text-sm text-gray-600">Click on municipality data below</p>
                            </div>

                            <!-- Loading Indicator -->
                            <div id="panel-loading" class="hidden">
                                <div class="flex items-center justify-center py-12">
                                    <svg class="animate-spin h-8 w-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>

                            <!-- Panel Content -->
                            <div id="panel-content" class="space-y-6">
                                <!-- Overview Stats -->
                                <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-3">Overview</h3>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <p class="text-xs text-gray-600">Total Production</p>
                                            <p id="detail-production" class="text-lg font-bold text-green-700">-</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-600">Area Harvested</p>
                                            <p id="detail-area" class="text-lg font-bold text-green-700">-</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-600">Productivity</p>
                                            <p id="detail-productivity" class="text-lg font-bold text-green-700">-</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-600">Records</p>
                                            <p id="detail-records" class="text-lg font-bold text-green-700">-</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Farm Type Breakdown -->
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-3">Farm Type Distribution</h3>
                                    <div id="farm-type-container" class="space-y-2">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>

                                <!-- Monthly Production Chart -->
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-3">Monthly Production</h3>
                                    <canvas id="monthly-chart" height="200"></canvas>
                                </div>

                                <!-- Crop Distribution Chart -->
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-3">Crop Distribution</h3>
                                    <canvas id="crop-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Panel -->
            <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg mt-4 lg:mt-6">
                <div class="p-4 lg:p-6">
                    <h3 class="text-base lg:text-lg font-semibold text-gray-800 mb-3 lg:mb-4">Summary Statistics</h3>
                    <div id="stats-content" class="grid grid-cols-2 md:grid-cols-4 gap-3 lg:gap-4">
                        <div class="text-center">
                            <p class="text-xs lg:text-sm text-gray-600">Total Production</p>
                            <p id="stat-total" class="text-lg lg:text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs lg:text-sm text-gray-600">Average</p>
                            <p id="stat-avg" class="text-lg lg:text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs lg:text-sm text-gray-600">Highest</p>
                            <p id="stat-max" class="text-lg lg:text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs lg:text-sm text-gray-600">Lowest</p>
                            <p id="stat-min" class="text-lg lg:text-2xl font-bold text-green-600">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        let map;
        let geojsonLayer;
        let currentData = {};
        let filterOptions = {};
        
        // Base URLs using Laravel's url() helper
        const apiBase = '{{ url("/api/map") }}';
        const dataPath = '{{ asset("data") }}';
        
        // User preferences from server
        const userPreferredMunicipality = '{{ $preferredMunicipality ?? '' }}';
        const userFavoriteCrops = @json($favoriteCrops ?? []);

        // Municipality coordinates for focusing
        const municipalityCoords = {
            'ATOK': [16.5917, 120.7083],
            'BAKUN': [16.7833, 120.6667],
            'BOKOD': [16.4833, 120.8167],
            'BUGUIAS': [16.7333, 120.8333],
            'ITOGON': [16.3667, 120.6833],
            'KABAYAN': [16.6167, 120.8500],
            'KAPANGAN': [16.5667, 120.6000],
            'KIBUNGAN': [16.6833, 120.6500],
            'LA TRINIDAD': [16.4500, 120.5833],
            'MANKAYAN': [16.8667, 120.7833],
            'SABLAN': [16.4833, 120.5000],
            'TUBA': [16.3333, 120.5500],
            'TUBLAY': [16.5000, 120.6167]
        };

        // Initialize map
        function initMap() {
            console.log('Initializing map...');
            
            // If user has preferred municipality, center on it
            let initialCenter = [16.5, 120.7];
            let initialZoom = 10;
            
            if (userPreferredMunicipality && municipalityCoords[userPreferredMunicipality]) {
                initialCenter = municipalityCoords[userPreferredMunicipality];
                initialZoom = 12;
            }
            
            map = L.map('map').setView(initialCenter, initialZoom);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            console.log('Map initialized, loading filters...');
            // Load filters
            loadFilters();
        }
        
        // Focus on user's municipality
        function focusOnMyMunicipality() {
            if (userPreferredMunicipality && municipalityCoords[userPreferredMunicipality]) {
                map.setView(municipalityCoords[userPreferredMunicipality], 12);
                
                // Open the details panel for this municipality
                loadMunicipalityDetails(userPreferredMunicipality);
            }
        }

        // Toggle legend on mobile
        function toggleLegend() {
            const wrapper = document.getElementById('legend-wrapper');
            const icon = document.getElementById('legend-icon');
            
            if (wrapper.classList.contains('hidden')) {
                wrapper.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                wrapper.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        // Load filter options from API
        async function loadFilters() {
            try {
                console.log('Fetching filters from:', `${apiBase}/filters`);
                const response = await fetch(`${apiBase}/filters`);
                console.log('Filter response:', response);
                filterOptions = await response.json();
                console.log('Filter options loaded:', filterOptions);

                // Populate crop dropdown
                const cropSelect = document.getElementById('crop-filter');
                cropSelect.innerHTML = '<option value="">All Crops</option>';
                filterOptions.crops.forEach(crop => {
                    cropSelect.innerHTML += `<option value="${crop}">${crop}</option>`;
                });
                
                // Auto-select user's favorite crop if available
                if (userFavoriteCrops.length > 0) {
                    const favoriteCropUpper = userFavoriteCrops[0].toUpperCase();
                    const matchingCrop = filterOptions.crops.find(c => c.toUpperCase() === favoriteCropUpper);
                    if (matchingCrop) {
                        cropSelect.value = matchingCrop;
                    }
                }

                // Populate year dropdown
                const yearSelect = document.getElementById('year-filter');
                yearSelect.innerHTML = '<option value="">All Years</option>';
                filterOptions.years.forEach(year => {
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                });

                // Set default year to latest
                yearSelect.value = filterOptions.years[filterOptions.years.length - 1];

                // Load initial map data
                loadMapData();
            } catch (error) {
                console.error('Error loading filters:', error);
                alert('Error loading filters. Please check console for details.');
                document.getElementById('crop-filter').innerHTML = '<option value="">Error loading crops</option>';
                document.getElementById('year-filter').innerHTML = '<option value="">Error loading years</option>';
            }
        }

        // Load map data from API
        async function loadMapData() {
            const crop = document.getElementById('crop-filter').value;
            const year = document.getElementById('year-filter').value;
            const view = document.getElementById('view-filter').value;
            const farmType = document.getElementById('farm-type-filter').value;

            // Show loading
            document.getElementById('loading-indicator').classList.remove('hidden');

            try {
                const params = new URLSearchParams();
                if (crop) params.append('crop', crop);
                if (year) params.append('year', year);
                if (view) params.append('view', view);
                if (farmType) params.append('farm_type', farmType);

                const response = await fetch(`${apiBase}/data?${params}`);
                const data = await response.json();

                currentData = data;
                updateMap(data);
                updateStats(data);
            } catch (error) {
                console.error('Error loading map data:', error);
                alert('Error loading map data: ' + error.message);
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        // Update map with choropleth
        function updateMap(data) {
            // Remove existing layer
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }

            // Use the dataPath from Laravel's asset() helper
            const geojsonPath = `${dataPath}/benguet.geojson`;

            // Load GeoJSON
            fetch(geojsonPath)
                .then(response => response.json())
                .then(geojson => {
                    geojsonLayer = L.geoJSON(geojson, {
                        style: feature => getStyle(feature, data),
                        onEachFeature: (feature, layer) => {
                            const municipalityName = feature.properties.name;
                            const municipalityData = data.data.find(d => 
                                d.municipality.toUpperCase() === municipalityName.toUpperCase()
                            );

                            // Popup
                            let popupContent = `<strong>${municipalityName}</strong><br>`;
                            if (municipalityData) {
                                const viewType = document.getElementById('view-filter').value;
                                const unit = getUnit(viewType);
                                popupContent += `${getViewLabel(viewType)}: ${Number(municipalityData.value).toLocaleString()} ${unit}`;
                            } else {
                                popupContent += 'No data available';
                            }
                            layer.bindPopup(popupContent);

                            // Hover effect
                            layer.on({
                                mouseover: e => {
                                    layer.setStyle({
                                        weight: 3,
                                        color: '#666',
                                        fillOpacity: 0.9
                                    });
                                },
                                mouseout: e => {
                                    geojsonLayer.resetStyle(layer);
                                },
                                click: e => {
                                    loadMunicipalityDetails(municipalityName);
                                }
                            });
                        }
                    }).addTo(map);

                    // Update legend
                    updateLegend(data);
                    
                    // Highlight user's preferred municipality
                    if (userPreferredMunicipality) {
                        highlightUserMunicipality();
                    }
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                    alert('Error loading map boundaries: ' + error.message + '\nPath: ' + geojsonPath);
                });
        }
        
        // Highlight user's preferred municipality with a special border
        function highlightUserMunicipality() {
            if (!geojsonLayer || !userPreferredMunicipality) return;
            
            geojsonLayer.eachLayer(layer => {
                const name = layer.feature.properties.name;
                if (name.toUpperCase() === userPreferredMunicipality.toUpperCase()) {
                    layer.setStyle({
                        weight: 4,
                        color: '#7c3aed', // Purple border for user's location
                        dashArray: '5, 5'
                    });
                    layer.bringToFront();
                }
            });
        }

        // Get style for municipality based on value
        function getStyle(feature, data) {
            const municipalityName = feature.properties.name;
            const municipalityData = data.data.find(d => 
                d.municipality.toUpperCase() === municipalityName.toUpperCase()
            );
            
            // Check if this is the user's preferred municipality
            const isUserMunicipality = userPreferredMunicipality && 
                municipalityName.toUpperCase() === userPreferredMunicipality.toUpperCase();

            let fillColor = '#d3d3d3'; // Default gray for no data

            if (municipalityData && data.metadata) {
                const value = municipalityData.value;
                const { min, max } = data.metadata;
                
                // Calculate color based on value (green gradient)
                const ratio = (value - min) / (max - min);
                fillColor = getColor(ratio);
            }

            return {
                fillColor: fillColor,
                weight: isUserMunicipality ? 4 : 2,
                opacity: 1,
                color: isUserMunicipality ? '#7c3aed' : 'white',
                dashArray: isUserMunicipality ? '5, 5' : null,
                fillOpacity: 0.7
            };
        }

        // Get color for value ratio (0-1)
        function getColor(ratio) {
            // Blue to Red gradient - much easier to distinguish
            const colors = [
                '#0ea5e9', // Sky blue (lowest)
                '#22c55e', // Green
                '#84cc16', // Lime green
                '#eab308', // Yellow
                '#f59e0b', // Amber
                '#f97316', // Orange
                '#ef4444', // Red
                '#dc2626', // Dark red
                '#991b1b'  // Very dark red (highest)
            ];

            const index = Math.floor(ratio * (colors.length - 1));
            return colors[index];
        }

        // Update legend
        function updateLegend(data) {
            const legendContent = document.getElementById('legend-content');
            
            if (!data.metadata) {
                legendContent.innerHTML = '<span class="text-sm text-gray-600">No data available</span>';
                return;
            }

            const { min, max } = data.metadata;
            const viewType = document.getElementById('view-filter').value;
            const unit = getUnit(viewType);

            legendContent.innerHTML = `
                <div class="space-y-2">
                    <!-- Color gradient -->
                    <div class="flex flex-col gap-1.5">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border-2 border-gray-400" style="background-color: #991b1b;"></div>
                            <span class="text-xs font-semibold text-gray-700">Highest</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #dc2626;"></div>
                            <span class="text-xs text-gray-600">Very High</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #ef4444;"></div>
                            <span class="text-xs text-gray-600">High</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #f97316;"></div>
                            <span class="text-xs text-gray-600">Medium-High</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #f59e0b;"></div>
                            <span class="text-xs text-gray-600">Medium</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #eab308;"></div>
                            <span class="text-xs text-gray-600">Medium-Low</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #84cc16;"></div>
                            <span class="text-xs text-gray-600">Low</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #22c55e;"></div>
                            <span class="text-xs text-gray-600">Very Low</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border-2 border-gray-400" style="background-color: #0ea5e9;"></div>
                            <span class="text-xs font-semibold text-gray-700">Lowest</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-6 rounded border border-gray-300" style="background-color: #ffffff;"></div>
                            <span class="text-xs text-gray-600">No data</span>
                        </div>
                    </div>
                    
                    <!-- Range values -->
                    <div class="pt-2 border-t border-gray-200">
                        <div class="text-xs text-gray-600">
                            <div><span class="font-medium">Max:</span> <span class="font-bold" style="color: #991b1b;">${Number(max).toLocaleString()} ${unit}</span></div>
                            <div><span class="font-medium">Min:</span> <span class="font-bold" style="color: #0ea5e9;">${Number(min).toLocaleString()} ${unit}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update statistics
        function updateStats(data) {
            const viewType = document.getElementById('view-filter').value;
            const unit = getUnit(viewType);

            if (data.metadata) {
                const total = Number(data.metadata.total) || 0;
                const avg = Number(data.metadata.avg) || 0;  // Backend sends 'avg', not 'average'
                const max = Number(data.metadata.max) || 0;
                const min = Number(data.metadata.min) || 0;
                
                document.getElementById('stat-total').textContent = total.toLocaleString() + ' ' + unit;
                document.getElementById('stat-avg').textContent = avg.toLocaleString() + ' ' + unit;
                document.getElementById('stat-max').textContent = max.toLocaleString() + ' ' + unit;
                document.getElementById('stat-min').textContent = min.toLocaleString() + ' ' + unit;
            } else {
                document.getElementById('stat-total').textContent = '-';
                document.getElementById('stat-avg').textContent = '-';
                document.getElementById('stat-max').textContent = '-';
                document.getElementById('stat-min').textContent = '-';
            }
        }

        // Get unit label
        function getUnit(viewType) {
            switch(viewType) {
                case 'production': return 'kg';
                case 'area_harvested': return 'ha';
                case 'productivity': return 'kg/ha';
                default: return '';
            }
        }

        // Get view label
        function getViewLabel(viewType) {
            switch(viewType) {
                case 'production': return 'Production';
                case 'area_harvested': return 'Area Harvested';
                case 'productivity': return 'Productivity';
                default: return 'Value';
            }
        }

        // Municipality Details Panel Functions
        let monthlyChart = null;
        let cropChart = null;

        function closeDetailsPanel() {
            document.getElementById('details-panel').classList.add('translate-x-full');
        }

        function openDetailsPanel() {
            document.getElementById('details-panel').classList.remove('translate-x-full');
        }

        async function loadMunicipalityDetails(municipalityName) {
            console.log('Loading details for:', municipalityName);
            
            // Show panel
            openDetailsPanel();
            
            // Update header
            document.getElementById('panel-municipality-name').textContent = municipalityName;
            
            // Show loading
            document.getElementById('panel-loading').classList.remove('hidden');
            document.getElementById('panel-content').classList.add('hidden');
            
            try {
                const crop = document.getElementById('crop-filter').value;
                const year = document.getElementById('year-filter').value;
                const farmType = document.getElementById('farm-type-filter').value;
                
                const params = new URLSearchParams();
                if (crop) params.append('crop', crop);
                if (year) params.append('year', year);
                if (farmType) params.append('farm_type', farmType);
                
                const response = await fetch(`${apiBase}/municipality/${encodeURIComponent(municipalityName)}?${params}`);
                const data = await response.json();
                
                console.log('Municipality data:', data);
                
                // Update overview stats
                document.getElementById('detail-production').textContent = Number(data.summary.total_production).toLocaleString() + ' kg';
                document.getElementById('detail-area').textContent = Number(data.summary.total_area_harvested).toLocaleString() + ' ha';
                document.getElementById('detail-productivity').textContent = Number(data.summary.avg_productivity).toFixed(2) + ' kg/ha';
                document.getElementById('detail-records').textContent = data.monthly_data.length + ' months';
                
                // Update farm type breakdown
                updateFarmTypeBreakdown(data.farm_type_breakdown);
                
                // Update charts
                updateMonthlyChart(data.monthly_data);
                updateCropChart(data.crop_distribution);
                
                // Hide loading, show content
                document.getElementById('panel-loading').classList.add('hidden');
                document.getElementById('panel-content').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading municipality details:', error);
                alert('Error loading details: ' + error.message);
                closeDetailsPanel();
            }
        }

        function updateFarmTypeBreakdown(farmTypes) {
            const container = document.getElementById('farm-type-container');
            
            if (!farmTypes || farmTypes.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No farm type data available</p>';
                return;
            }
            
            const total = farmTypes.reduce((sum, ft) => sum + parseFloat(ft.total_production), 0);
            
            container.innerHTML = farmTypes.map(ft => {
                const production = parseFloat(ft.total_production);
                const percentage = ((production / total) * 100).toFixed(1);
                return `
                    <div class="bg-gray-50 p-3 rounded border border-gray-200">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">${ft.farm_type}</span>
                            <span class="text-sm font-bold text-green-600">${percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">${Number(production).toLocaleString()} kg</p>
                    </div>
                `;
            }).join('');
        }

        function updateMonthlyChart(monthlyData) {
            const ctx = document.getElementById('monthly-chart');
            
            // Destroy existing chart
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const data = monthNames.map((monthName) => {
                const monthData = monthlyData.find(m => m.month === monthName);
                return monthData ? parseFloat(monthData.total_production) : 0;
            });
            
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Production (kg)',
                        data: data,
                        backgroundColor: 'rgba(34, 197, 94, 0.7)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCropChart(cropData) {
            const ctx = document.getElementById('crop-chart');
            
            // Destroy existing chart
            if (cropChart) {
                cropChart.destroy();
            }
            
            if (cropData.length === 0) {
                ctx.parentElement.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No crop data available</p>';
                return;
            }
            
            const colors = [
                '#ef4444', '#f59e0b', '#eab308', '#84cc16', '#22c55e',
                '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1'
            ];
            
            cropChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: cropData.map(c => c.crop),
                    datasets: [{
                        data: cropData.map(c => parseFloat(c.total_production)),
                        backgroundColor: colors.slice(0, cropData.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = Number(context.parsed).toLocaleString();
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} kg (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Toggle boundaries visibility
        function toggleBoundaries(show) {
            if (!geojsonLayer) return;
            
            if (show) {
                if (!map.hasLayer(geojsonLayer)) {
                    geojsonLayer.addTo(map);
                }
            } else {
                if (map.hasLayer(geojsonLayer)) {
                    map.removeLayer(geojsonLayer);
                }
            }
        }

        // Event listeners
        document.getElementById('crop-filter').addEventListener('change', loadMapData);
        document.getElementById('year-filter').addEventListener('change', loadMapData);
        document.getElementById('view-filter').addEventListener('change', loadMapData);
        document.getElementById('farm-type-filter').addEventListener('change', loadMapData);
        document.getElementById('toggle-boundaries').addEventListener('change', function() {
            toggleBoundaries(this.checked);
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</x-app-layout>
